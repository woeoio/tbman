# 重定向处理

## 自动重定向（默认）

WinHttpRequest 默认自动跟随 3xx 重定向：

```vb
Dim http As New cHttpClient
http.SendGet("https://bit.ly/3xxxxx")  ' 自动跟随 301/302 跳转
Debug.Print http.ReturnText()          ' 获取最终页面的内容
```

## 禁用自动重定向

### 禁用重定向

```vb
http.AllowRedirects(False).SendGet("https://example.com/redirect")
Debug.Print http.Inst.Status           ' 302
Debug.Print http.GetRedirectUrl()      ' 获取 Location 头的重定向地址
```

### AllowRedirects 方法

```vb
Public Function AllowRedirects(Bool As Boolean) As cHttpClient
```

**示例：**
```vb
http.AllowRedirects(False) _
    .SendGet("https://example.com/old-page")
```

## 手动跟随重定向

### FollowRedirect 方法

```vb
Public Function FollowRedirect() As cHttpClient
```

**基本用法：**
```vb
http.AllowRedirects(False).SendGet("https://a.com")

If http.Inst.Status = 302 Then
    Debug.Print "重定向到: " & http.GetRedirectUrl()
    http.FollowRedirect()  ' 自动请求重定向地址
End If

Debug.Print "最终内容: " & http.ReturnText()
```

### 处理重定向链

```vb
http.AllowRedirects(False).ResetRedirectCount()

Do
    http.SendGet(currentUrl)
    
    If http.Inst.Status >= 300 And http.Inst.Status < 400 Then
        Debug.Print "重定向 " & http.Inst.Status & " -> " & http.GetRedirectUrl()
        http.FollowRedirect()
    Else
        Exit Do
    End If
Loop
```

## 最大重定向次数

```vb
Public MaxRedirects As Long  ' 默认 10 次
```

**示例：**
```vb
http.MaxRedirects = 5  ' 最多允许 5 次重定向

http.AllowRedirects(False).SendGet("https://a.com")
http.FollowRedirect()  ' 计数 +1
http.FollowRedirect()  ' 计数 +2
' 超过 MaxRedirects 将抛出错误
```

## 重置重定向计数

```vb
Public Function ResetRedirectCount() As cHttpClient
```

**示例：**
```vb
http.AllowRedirects(False).ResetRedirectCount().SendGet("https://a.com")
```

## 获取重定向地址

```vb
Public Function GetRedirectUrl() As String
```

从 `Location` 响应头中提取重定向 URL：

```vb
Dim redirectUrl As String
redirectUrl = http.GetRedirectUrl()
If redirectUrl <> "" Then
    Debug.Print "重定向到: " & redirectUrl
End If
```

## 重定向行为说明

| 状态码 | 自动重定向行为 | 手动 FollowRedirect 行为 |
|--------|----------------|-------------------------|
| 301 | 自动转为 GET | 转为 GET 请求 |
| 302 | 自动转为 GET | 转为 GET 请求 |
| 303 | 自动转为 GET | 转为 GET 请求 |
| 307 | 保持原方法 | 保持原方法 |
| 308 | 保持原方法 | 保持原方法 |

## 实际应用场景

### 场景 1：记录重定向链

```vb
Sub TraceRedirects()
    Dim http As New cHttpClient
    Dim redirectChain As String
    
    http.AllowRedirects(False).SendGet("https://bit.ly/3xxxxx")
    redirectChain = "起始 URL"
    
    Do While http.Inst.Status >= 300 And http.Inst.Status < 400
        redirectChain = redirectChain & " -> " & http.GetRedirectUrl()
        http.FollowRedirect()
    Loop
    
    Debug.Print "重定向链: " & redirectChain
    Debug.Print "最终状态: " & http.Inst.Status
End Sub
```

### 场景 2：修改重定向请求

```vb
' 在重定向前修改请求头
http.AllowRedirects(False).SendGet("https://a.com")

If http.Inst.Status = 302 Then
    ' 添加额外的请求头
    http.RequestHeaders.Add "X-Special-Header", "value"
    http.FollowRedirect()
End If
```

### 场景 3：检测循环重定向

```vb
http.AllowRedirects(False).ResetRedirectCount().SendGet("https://a.com")

Do While http.Inst.Status >= 300 And http.Inst.Status < 400
    If http.RedirectCount > 10 Then
        Debug.Print "检测到循环重定向！"
        Exit Do
    End If
    http.FollowRedirect()
Loop
```
