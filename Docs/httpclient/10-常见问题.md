# 常见问题

## 基础问题

### Q: 如何设置请求头？

**A:** 使用 `RequestHeaders` 字典：

```vb
http.RequestHeaders.Add "Authorization", "Bearer token123"
http.RequestHeaders.Add "X-Custom-Header", "value"
```

### Q: 如何处理中文字符？

**A:** 默认使用 UTF-8 编码，无需额外处理：

```vb
http.RequestDataForm.Add "name", "中文内容"
http.SendPost("https://api.example.com/submit")
```

### Q: 如何发送 JSON 数据？

**A:** 设置 Content-Type 为 JSON 并添加数据：

```vb
http.SetRequestContentType(Json)
http.RequestDataJson.Add "key", "value"
http.RequestDataJson.Add "number", 123
http.SendPost("https://api.example.com/api")
```

---

## 错误处理

### Q: 请求超时怎么办？

**A:** 增加超时时间：

```vb
http.RequestTimeOut = 60  ' 60 秒
```

### Q: 如何处理 404 错误？

**A:** 使用错误处理：

```vb
On Error Resume Next
http.SendGet("https://api.example.com/not-found")

If http.Inst.Status = 404 Then
    Debug.Print "资源不存在"
ElseIf Err.Number <> 0 Then
    Debug.Print "错误: " & Err.Description
End If
On Error GoTo 0
```

### Q: SSL 证书错误如何处理？

**A:** 内部已自动忽略 SSL 证书错误，无需额外处理。

---

## 重定向问题

### Q: 如何禁止自动重定向？

**A:** 使用 `AllowRedirects`：

```vb
http.AllowRedirects(False).SendGet("https://example.com/redirect")
Debug.Print http.Inst.Status  ' 302
Debug.Print http.GetRedirectUrl()  ' 获取重定向地址
```

### Q: 如何手动跟随重定向？

**A:** 使用 `FollowRedirect`：

```vb
http.AllowRedirects(False).SendGet("https://a.com")
If http.Inst.Status = 302 Then
    http.FollowRedirect()  ' 自动请求重定向地址
End If
```

### Q: 如何限制重定向次数？

**A:** 设置 `MaxRedirects`：

```vb
http.MaxRedirects = 5
```

---

## 响应处理问题

### Q: 响应内容乱码怎么办？

**A:** 尝试不同的解码方式：

```vb
' 方式 1: UTF-8（默认）
text = http.ReturnText(True)

' 方式 2: 系统编码
text = http.ReturnText(False)

' 方式 3: 强制转换
text = http.ReturnText(False, True)
```

### Q: 如何获取二进制响应？

**A:** 使用 `ReturnBody`：

```vb
Dim bytes() As Byte
bytes = http.ReturnBody()
```

### Q: 如何获取响应头？

**A:** 使用 `ResponseHeaders`：

```vb
If http.ResponseHeaders.Exists("Content-Type") Then
    Debug.Print http.ResponseHeaders("Content-Type")
End If
```

---

## Cookie 和会话

### Q: 如何设置 Cookie？

**A:** 使用 `SetCookies`：

```vb
http.SetCookies("session=abc123; user=john")
```

### Q: 如何保持会话？

**A:** 使用同一个实例：

```vb
Dim http As New cHttpClient

' 登录
http.SendPost("https://api.example.com/login")

' 后续请求自动保持会话
http.SendGet("https://api.example.com/profile")
```

---

## 性能优化

### Q: 如何提高请求速度？

**A:** 
1. 重用实例（保持连接复用）
2. 适当设置超时时间
3. 使用异步请求

### Q: 如何并发发送多个请求？

**A:** 使用多个实例：

```vb
Dim http1 As New cHttpClient
Dim http2 As New cHttpClient

http1.Async(True).SendGet("https://api.a.com")
http2.Async(True).SendGet("https://api.b.com")
```

---

## 调试问题

### Q: 如何查看完整的请求和响应？

**A:** 开启调试模式：

```vb
http.DebugStart = True
http.SendGet("https://api.example.com/data")
Debug.Print http.DebugInfo.Encode(, , True)
```

### Q: 如何记录请求日志？

**A:** 

```vb
http.DebugStart = True
http.SendGet("https://api.example.com/data")

Open "C:\log.txt" For Output As #1
Print #1, http.DebugInfo.Encode(, , True)
Close #1
```

---

## 特殊场景

### Q: 如何上传文件？

**A:** 参考高级用法中的文件上传示例。

### Q: 如何下载文件？

**A:** 

```vb
http.SendGet("https://example.com/file.pdf")
If http.Inst.Status = 200 Then
    Open "C:\file.pdf" For Binary As #1
    Put #1, , http.ReturnBody()
    Close #1
End If
```

### Q: 如何处理分页 API？

**A:** 

```vb
Dim page As Long
page = 1

Do
    http.RequestDataQuery.Add "page", page
    http.SendGet("https://api.example.com/items")
    
    ' 处理数据...
    
    page = page + 1
Loop While HasMorePages(http.ReturnJson())
```

---

## 已知限制

1. **WinHTTP 限制** - 某些高级功能依赖 WinHTTP 组件能力
2. **字符编码** - 主要支持 UTF-8，其他编码可能需要额外处理
3. **大文件** - 超大文件上传/下载可能需要流式处理
4. **WebSocket** - 不支持 WebSocket 协议

---

## 获取帮助

- 查看 `Docs/httpclient/` 完整文档
- 参考代码示例
- 检查调试信息
